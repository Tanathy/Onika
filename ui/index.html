<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="ui.common.app_title"></title>
    <link rel="icon" href="/ui/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/ui/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="notification-container"></div>
    <div id="xref-layer" class="xref-layer"></div>
    <template id="xref-pointer-template">
        <button type="button" class="xref-pointer" aria-label="Go to setting">
            <span class="xref-pointer-dot" aria-hidden="true"></span>
            <span class="xref-pointer-label"></span>
        </button>
    </template>
    <div class="app-container">
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <button id="nav-training" class="nav-item active" onclick="openTab('training')" data-lang-key="ui.sidebar.training"></button>
            <button class="nav-item" onclick="openTab('console')" data-lang-key="ui.sidebar.console"></button>
            <button class="nav-item" onclick="openTab('metadata')" data-lang-key="ui.sidebar.metadata"></button>
            <button class="nav-item" onclick="openTab('updates')" data-lang-key="ui.sidebar.updates"></button>
            <!-- <button class="nav-item" onclick="openTab('conversion')">Conversion</button> -->
            
            <div style="flex: 1;"></div>
            
            <div class="card" style="padding: 10px; margin-bottom: 10px;">
                <div class="preset-row" style="margin-bottom: 0;">
                    <label style="min-width: auto; margin-right: 10px;" data-lang-key="ui.sidebar.language"></label>
                    <select id="language-selector" style="flex: 1;">
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <div class="card" style="padding: 14px;">
                <div class="card-title" style="margin-bottom: 8px;" data-lang-key="ui.sidebar.system"></div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="status-dot" id="system-dot"></span>
                    <span id="system-status" style="font-size: 12px;" data-lang-key="ui.sidebar.connecting"></span>
                </div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            
            <!-- UPDATES TAB -->
            <div id="tab-updates" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title" data-lang-key="ui.updates.title"></h1>
                    <p class="page-subtitle" data-lang-key="ui.updates.subtitle"></p>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div id="update-status-text" style="font-weight: 500;" data-lang-key="ui.updates.check_status_default"></div>
                        <div style="display: flex; gap: 10px;">
                            <button id="btn-check-updates" class="btn-primary" onclick="checkUpdates()" data-lang-key="ui.updates.btn_check"></button>
                            <button id="btn-apply-updates" class="btn-success" onclick="applyUpdates()" style="display: none; background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;" data-lang-key="ui.updates.btn_apply"></button>
                        </div>
                    </div>
                </div>

                <div id="update-info-card" class="card" style="display: none;">
                    <div class="card-title" style="margin-bottom: 15px;" data-lang-key="ui.updates.details_title"></div>
                    <div id="update-summary" style="margin-bottom: 15px; font-size: 13px; color: var(--text-secondary);"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 120px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px;">
                        <span data-lang-key="ui.updates.col_file"></span>
                        <span style="text-align: center;" data-lang-key="ui.updates.col_status"></span>
                    </div>
                    <div id="update-file-list" style="display: flex; flex-direction: column; gap: 5px; max-height: 300px; overflow-y: auto;">
                        <!-- Files will be listed here -->
                    </div>
                </div>

                <div id="update-log-card" class="card" style="display: none;">
                    <div class="card-title" style="margin-bottom: 10px;" data-lang-key="ui.updates.log_title"></div>
                    <div id="update-log" style="background: #000; color: #0f0; padding: 15px; border-radius: 8px; font-family: var(--font-mono); font-size: 12px; height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
                </div>
            </div>

            <!-- TRAINING TAB -->
            <div id="tab-training" class="tab-content active">
                <div class="page-header">
                    <h1 class="page-title" data-lang-key="ui.training.title"></h1>
                    <p class="page-subtitle" data-lang-key="ui.training.subtitle"></p>
                </div>

                <!-- Loss Display and Status moved to progress section -->

                <!-- Preset Selector -->
                <div class="card preset-card">
                    <div class="preset-row">
                        <label data-lang-key="ui.training.preset.label"></label>
                        <select id="preset_selector">
                            <option value="" data-lang-key="ui.training.preset.select_placeholder"></option>
                        </select>
                    </div>
                    <div class="preset-row preset-buttons">
                        <button class="btn-primary" onclick="loadSelectedPreset()" data-lang-key="ui.training.preset.btn_load"></button>
                        <button id="btn-save-preset" type="button" class="btn-secondary" data-lang-key="ui.training.preset.btn_save"></button>
                        <button id="btn-new-preset" type="button" class="btn-secondary" data-lang-key="ui.training.preset.btn_new"></button>
                        <button id="btn-delete-preset" type="button" class="btn-danger" data-lang-key="ui.training.preset.btn_delete"></button>
                    </div>
                    <div class="help-text" data-lang-key="ui.training.preset.help"></div>
                </div>

                <!-- Config Tabs -->
                        <div class="card">
                    <div class="sub-tabs">
                        <button id="subtab-model" type="button" class="sub-tab-btn active" onclick="openSubTab('cfg-model')" data-lang-key="ui.training.tabs.model"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-network')" data-lang-key="ui.training.tabs.network"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-dataset')" data-lang-key="ui.training.tabs.dataset"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-te')" data-lang-key="ui.training.tabs.text_encoder"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-aug')" data-lang-key="ui.training.tabs.aug"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-basic')" data-lang-key="ui.training.tabs.learning"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-advanced')" data-lang-key="ui.training.tabs.advanced"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-samples')" data-lang-key="ui.training.tabs.samples"></button>
                        <button type="button" class="sub-tab-btn" onclick="openSubTab('cfg-meta')" data-lang-key="ui.training.tabs.metadata"></button>
                    </div>

                    <form id="training-form">
                        <!-- Model Config -->
                        <div id="cfg-model" class="sub-tab-content active">
                            <div class="form-group">
                                <label data-lang-key="ui.training.model.base_model"></label>
                                <select id="base_model_name" name="base_model_name"></select>
                                <div class="help-text" data-lang-key="ui.training.model.base_model_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.model.architecture"></label>
                                <select id="model_type" name="model_type">
                                    <option value="sdxl" data-lang-key="ui.training.model.type_sdxl"></option>
                                    <option value="sd_legacy" data-lang-key="ui.training.model.type_sd_legacy"></option>
                                    <option value="sd3" data-lang-key="ui.training.model.type_sd3"></option>
                                    <option value="sd3.5" data-lang-key="ui.training.model.type_sd3_5"></option>
                                    <option value="flux1" data-lang-key="ui.training.model.type_flux1"></option>
                                    <option value="flux2" data-lang-key="ui.training.model.type_flux2"></option>
                                </select>
                                <div class="help-text" data-lang-key="ui.training.model.architecture_help"></div>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-secondary" onclick="autoOptimize()" data-lang-key="ui.training.model.btn_optimize"></button>
                                <div class="help-text" data-lang-key="ui.training.model.optimize_help"></div>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-secondary" onclick="autoAdjust()" data-lang-key="ui.training.model.btn_adjust"></button>
                                <div class="help-text" data-lang-key="ui.training.model.adjust_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="q_lora" data-lang-key="ui.training.model.quantization"></label>
                                <select id="quantization_bit" name="quantization_bit">
                                    <option value="" data-lang-key="ui.training.model.quantization_none"></option>
                                    <option value="8" data-lang-key="ui.training.model.quantization_8bit"></option>
                                    <option value="4" data-lang-key="ui.training.model.quantization_4bit"></option>
                                </select>
                                <div class="help-text" data-lang-key="ui.training.model.quantization_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.model.output_name"></label>
                                <input type="text" name="output_name" value="my_lora_v1" data-lang-placeholder="ui.training.model.output_name_placeholder">
                                <div class="help-text" data-lang-key="ui.training.model.output_name_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.model.output_dir"></label>
                                <input type="text" name="output_dir" value="project/outputs">
                                <div class="help-text" data-lang-key="ui.training.model.output_dir_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.model.save_precision"></label>
                                    <select name="save_precision">
                                        <option value="AUTO" selected>AUTO</option>
                                        <option value="float16">float16</option>
                                        <option value="bf16">bf16</option>
                                        <option value="float32">float32</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.model.save_precision_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.model.save_format"></label>
                                    <select name="save_model_as">
                                        <option value="safetensors">safetensors</option>
                                        <option value="ckpt">ckpt</option>
                                        <option value="diffusers">diffusers</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.model.save_format_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.model.save_epochs"></label>
                                    <input type="number" name="save_every_n_epochs" value="1">
                                    <div class="help-text" data-lang-key="ui.training.model.save_epochs_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.model.save_steps"></label>
                                    <input type="number" name="save_every_n_steps" data-lang-placeholder="ui.training.model.save_steps_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.model.save_steps_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.model.resume"></label>
                                <input type="text" name="resume_from_checkpoint" data-lang-placeholder="ui.training.model.resume_placeholder">
                                <div class="help-text" data-lang-key="ui.training.model.resume_help"></div>
                            </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="save_best_only">
                                        <span data-lang-key="ui.training.model.save_best"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.model.save_best_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.model.checkpoints_limit"></label>
                                    <input type="number" name="checkpoints_total_limit" data-lang-placeholder="ui.training.model.checkpoints_limit_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.model.checkpoints_limit_help"></div>
                                </div>
                            </div>                        <!-- Network Config -->
                        <div id="cfg-network" class="sub-tab-content">
                            <div class="form-group">
                                <label data-lang-key="ui.training.network.type"></label>
                                <select name="network_type" id="network_type" onchange="updateNetworkFields()">
                                    <option value="lora" data-lang-key="ui.training.network.type_lora"></option>
                                    <option value="loha" data-lang-key="ui.training.network.type_loha"></option>
                                    <option value="lokr" data-lang-key="ui.training.network.type_lokr"></option>
                                    <option value="lycoris" data-lang-key="ui.training.network.type_lycoris"></option>
                                    <option value="oft" data-lang-key="ui.training.network.type_oft"></option>
                                </select>
                                <div class="help-text" data-lang-key="ui.training.network.type_help"></div>
                            </div>
                            
                            <!-- LyCORIS Specific -->
                            <div id="lycoris_fields" class="conditional-fields hidden">
                                <div class="field-title" data-lang-key="ui.training.network.lycoris_settings"></div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.algo"></label>
                                    <select name="algo">
                                        <option value="lora">lora</option>
                                        <option value="loha">loha</option>
                                        <option value="lokr">lokr</option>
                                        <option value="locon">locon</option>
                                        <option value="full">full</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.network.algo_help"></div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.network.conv_dim"></label>
                                        <input type="number" name="conv_dim" data-lang-placeholder="ui.training.network.conv_dim_placeholder">
                                        <div class="help-text" data-lang-key="ui.training.network.conv_dim_help"></div>
                                    </div>
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.network.conv_alpha"></label>
                                        <input type="number" name="conv_alpha" data-lang-placeholder="ui.training.network.conv_alpha_placeholder">
                                        <div class="help-text" data-lang-key="ui.training.network.conv_alpha_help"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.dim"></label>
                                    <input type="number" name="network_dim" value="32">
                                    <div class="help-text" data-lang-key="ui.training.network.dim_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.alpha"></label>
                                    <input type="number" name="network_alpha" value="16">
                                    <div class="help-text" data-lang-key="ui.training.network.alpha_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.network.module"></label>
                                <input type="text" name="network_module" value="networks.lora" data-lang-placeholder="ui.training.network.module_placeholder">
                                <div class="help-text" data-lang-key="ui.training.network.module_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.network.args"></label>
                                <input type="text" name="network_args" data-lang-placeholder="ui.training.network.args_placeholder">
                                <div class="help-text" data-lang-key="ui.training.network.args_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.lora_layers"></label>
                                    <input type="text" name="lora_layers" data-lang-placeholder="ui.training.network.lora_layers_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.network.lora_layers_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.lora_blocks"></label>
                                    <input type="text" name="lora_blocks" data-lang-placeholder="ui.training.network.lora_blocks_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.network.lora_blocks_help"></div>
                                </div>
                            </div>
                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.network.advanced_lora"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.module_dropout"></label>
                                    <input type="number" name="module_dropout" value="0" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.network.module_dropout_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.rank_dropout"></label>
                                    <input type="number" name="rank_dropout" value="0" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.network.rank_dropout_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.network_dropout"></label>
                                    <input type="number" name="network_dropout" value="0" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.network.network_dropout_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.network.dora_wd"></label>
                                    <input type="number" name="dora_weight_decay" step="0.01" data-lang-placeholder="ui.training.network.dora_wd_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.network.dora_wd_help"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Dataset Config -->
                        <div id="cfg-dataset" class="sub-tab-content">
                            <div class="form-group">
                            <div class="help-text" data-lang-key="ui.training.dataset.sample_warning"></div>
                                <label data-lang-key="ui.training.dataset.path"></label>
                                <input type="text" name="dataset_path" value="project/dataset">
                                <div class="help-text" data-lang-key="ui.training.dataset.path_help"></div>
                            </div>
                            <div class="card" style="padding: 12px; margin-bottom: 12px;">
                                <div class="field-title" data-lang-key="ui.training.dataset.dreambooth"></div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="use_prior_preservation">
                                        <span data-lang-key="ui.training.dataset.prior_preservation"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.dataset.prior_preservation_help"></div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.dataset.instance_prompt"></label>
                                        <input type="text" name="instance_prompt" data-lang-placeholder="ui.training.dataset.instance_prompt_placeholder">
                                        <div class="help-text" data-lang-key="ui.training.dataset.instance_prompt_help"></div>
                                    </div>
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.dataset.class_prompt"></label>
                                        <input type="text" name="class_prompt" data-lang-placeholder="ui.training.dataset.class_prompt_placeholder">
                                        <div class="help-text" data-lang-key="ui.training.dataset.class_prompt_help"></div>
                                    </div>
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.dataset.neg_class_prompt"></label>
                                        <input type="text" name="reg_negative_prompt" data-lang-placeholder="ui.training.dataset.neg_class_prompt_placeholder">
                                        <div class="help-text" data-lang-key="ui.training.dataset.neg_class_prompt_help"></div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.dataset.reg_dir"></label>
                                        <input type="text" name="reg_data_dir" data-lang-placeholder="ui.training.dataset.reg_dir_placeholder">
                                        <div class="help-text" data-lang-key="ui.training.dataset.reg_dir_help"></div>
                                    </div>
                                    <div class="form-group">
                                        <label data-lang-key="ui.training.dataset.num_class_images"></label>
                                        <input type="number" name="num_class_images" value="0" min="0">
                                        <div class="help-text" data-lang-key="ui.training.dataset.num_class_images_help"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label" style="margin-bottom: 10px;">
                                        <input type="checkbox" name="auto_generate_reg_images" onchange="toggleRegGenSettings(this)">
                                        <span data-lang-key="ui.training.dataset.auto_gen"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.dataset.auto_gen_help"></div>
                                </div>

                                <div id="reg-gen-settings" style="padding: 10px;">
                                    <div class="field-title" style="font-size: 0.9em; margin-bottom: 10px; color: #aaa;" data-lang-key="ui.training.dataset.gen_settings"></div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label data-lang-key="ui.training.dataset.scheduler"></label>
                                            <select name="reg_scheduler">
                                                <option value="euler_a" selected>Euler A (Fast)</option>
                                                <option value="dpm++_2m_karras">DPM++ 2M Karras (Quality)</option>
                                                <option value="euler">Euler (Standard)</option>
                                            </select>
                                            <div class="help-text" data-lang-key="ui.training.dataset.scheduler_help"></div>
                                        </div>
                                        <div class="form-group">
                                            <label data-lang-key="ui.training.dataset.steps"></label>
                                            <input type="number" name="reg_infer_steps" value="20" min="1">
                                            <div class="help-text" data-lang-key="ui.training.dataset.steps_help"></div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label data-lang-key="ui.training.dataset.guidance"></label>
                                            <input type="number" name="reg_guidance_scale" value="7.5" step="0.1">
                                            <div class="help-text" data-lang-key="ui.training.dataset.guidance_help"></div>
                                        </div>
                                        <div class="form-group">
                                            <label data-lang-key="ui.training.dataset.seed"></label>
                                            <input type="number" name="reg_seed" value="-1">
                                            <div class="help-text" data-lang-key="ui.training.dataset.seed_help"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Duplicate DreamBooth/Prior card removed; single source of truth above -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="resolution" data-lang-key="ui.training.dataset.resolution"></label>
                                    <select id="resolution" name="resolution">
                                        <option value="512">512 x 512 (SD 1.5)</option>
                                        <option value="768">768 x 768 (SD 2.0/2.1)</option>
                                        <option value="1024" selected>1024 x 1024 (SDXL Default)</option>
                                        <option value="1280">1280 x 1280 (SDXL High)</option>
                                        <option value="1536">1536 x 1536 (SDXL Ultra)</option>
                                        <option value="2048">2048 x 2048 (Flux/Extreme)</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.dataset.resolution_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="batch_size" data-lang-key="ui.training.dataset.batch_size"></label>
                                    <input type="number" name="batch_size" value="1">
                                    <div class="help-text" data-lang-key="ui.training.dataset.batch_size_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.dataset.max_epochs"></label>
                                    <input type="number" name="max_train_epochs" value="10">
                                    <div class="help-text" data-lang-key="ui.training.dataset.max_epochs_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.dataset.max_steps"></label>
                                    <input type="number" name="max_train_steps" data-lang-placeholder="ui.training.dataset.max_steps_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.dataset.max_steps_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="center_crop" checked>
                                    <span data-lang-key="ui.training.dataset.center_crop"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.dataset.center_crop_help"></div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label" data-pointer="enable_bucket">
                                    <input type="checkbox" name="enable_bucket" checked>
                                    <span data-lang-key="ui.training.dataset.bucketing"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.dataset.bucketing_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="min_bucket_reso" data-lang-key="ui.training.dataset.min_bucket"></label>
                                    <input type="number" name="min_bucket_reso" value="256">
                                    <div class="help-text" data-lang-key="ui.training.dataset.min_bucket_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="max_bucket_reso" data-lang-key="ui.training.dataset.max_bucket"></label>
                                    <input type="number" name="max_bucket_reso" value="2048">
                                    <div class="help-text" data-lang-key="ui.training.dataset.max_bucket_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="bucket_reso_steps" data-lang-key="ui.training.dataset.bucket_steps"></label>
                                    <input type="number" name="bucket_reso_steps" value="64">
                                    <div class="help-text" data-lang-key="ui.training.dataset.bucket_steps_help"></div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label" style="margin-top: 30px;">
                                        <input type="checkbox" name="bucket_no_upscale">
                                        <span data-lang-key="ui.training.dataset.no_upscale"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.dataset.no_upscale_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="persistent_data_loader_workers">
                                    <span data-lang-key="ui.training.dataset.persistent_workers"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.dataset.persistent_workers_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.dataset.workers"></label>
                                    <input type="number" name="dataloader_num_workers" value="8" min="0">
                                    <div class="help-text" data-lang-key="ui.training.dataset.workers_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.dataset.shuffle"></label>
                                    <select name="dataloader_shuffle">
                                        <option value="true" selected>Shuffle</option>
                                        <option value="false">Deterministic order</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.dataset.shuffle_help"></div>
                                </div>
                            </div>
                            
                        </div>

                        <!-- Text Encoder Config -->
                        <div id="cfg-te" class="sub-tab-content">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="train_text_encoder" checked>
                                    <span data-lang-key="ui.training.text_encoder.train"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.text_encoder.train_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.clip_skip"></label>
                                    <input type="number" name="clip_skip" value="1" min="0" max="12">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.clip_skip_help"></div>
                                </div>
                            </div>
                            <div class="field-title" style="margin-top: 12px;" data-lang-key="ui.training.text_encoder.ti_title"></div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="train_textual_inversion">
                                    <span data-lang-key="ui.training.text_encoder.train_ti"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.text_encoder.train_ti_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.token_abs"></label>
                                    <input type="text" name="token_abstraction" value="TOK">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.token_abs_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.new_tokens"></label>
                                    <input type="number" name="num_new_tokens_per_abstraction" value="2" min="1">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.new_tokens_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.ti_frac"></label>
                                    <input type="number" name="train_text_encoder_ti_frac" value="0.5" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.ti_frac_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.te_frac"></label>
                                    <input type="number" name="train_text_encoder_frac" value="1.0" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.te_frac_help"></div>
                                </div>
                            </div>
                            <div class="field-title" style="margin-top: 12px;" data-lang-key="ui.training.text_encoder.weighting_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="weighted_captions">
                                        <span data-lang-key="ui.training.text_encoder.enable_weighted"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.enable_weighted_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.emphasis"></label>
                                    <input type="number" name="emphasis_strength" value="1.2" step="0.05" min="0.1" max="3">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.emphasis_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.text_encoder.de_emphasis"></label>
                                    <input type="number" name="de_emphasis_strength" value="0.8" step="0.05" min="0.1" max="3">
                                    <div class="help-text" data-lang-key="ui.training.text_encoder.de_emphasis_help"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Augmentation & Caching Config -->
                        <div id="cfg-aug" class="sub-tab-content">
                            <div class="field-title" data-lang-key="ui.training.aug.caching_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label" data-pointer="cache_latents">
                                        <input type="checkbox" name="cache_latents" checked>
                                        <span data-lang-key="ui.training.aug.cache_latents"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.aug.cache_latents_help"></div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label" data-pointer="cache_latents_disk">
                                        <input type="checkbox" name="cache_latents_to_disk">
                                        <span data-lang-key="ui.training.aug.cache_disk"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.aug.cache_disk_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="cache_text_embeddings">
                                    <span data-lang-key="ui.training.aug.cache_te"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.aug.cache_te_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="vae_batch" data-lang-key="ui.training.aug.vae_batch"></label>
                                <input type="number" name="vae_batch_size" data-lang-placeholder="ui.training.aug.vae_batch_placeholder">
                                <div class="help-text" data-lang-key="ui.training.aug.vae_batch_help"></div>
                            </div>

                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.aug.noise_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.aug.noise_offset"></label>
                                    <input type="number" name="noise_offset_strength" value="0" step="0.01">
                                    <div class="help-text" data-lang-key="ui.training.aug.noise_offset_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.aug.noise_random"></label>
                                    <input type="number" name="noise_offset_random_strength" value="0" step="0.01">
                                    <div class="help-text" data-lang-key="ui.training.aug.noise_random_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.aug.noise_type"></label>
                                    <select name="noise_offset_type">
                                        <option value="original">Original</option>
                                        <option value="alternative">Alternative</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.aug.noise_type_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.aug.adaptive_noise"></label>
                                    <input type="number" name="adaptive_noise_scale" value="0" step="0.01">
                                    <div class="help-text" data-lang-key="ui.training.aug.adaptive_noise_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.aug.multires_iter"></label>
                                    <input type="number" name="multires_noise_iterations" value="0">
                                    <div class="help-text" data-lang-key="ui.training.aug.multires_iter_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.aug.multires_discount"></label>
                                    <input type="number" name="multires_noise_discount" value="0" step="0.1">
                                    <div class="help-text" data-lang-key="ui.training.aug.multires_discount_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="do_edm_style_training">
                                    <span data-lang-key="ui.training.aug.edm"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.aug.edm_help"></div>
                            </div>

                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.aug.aug_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="aug_mode" data-lang-key="ui.training.aug.aug_mode"></label>
                                    <select name="augmentation_mode">
                                        <option value="always">Always</option>
                                        <option value="per_epoch">Per Epoch Only</option>
                                        <option value="random">Random Probability</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.aug.aug_mode_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="color_aug_strength" data-lang-key="ui.training.aug.color_aug"></label>
                                    <input type="number" name="color_aug_strength" value="0.5" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.aug.color_aug_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="flip_aug_probability" data-lang-key="ui.training.aug.flip_aug"></label>
                                    <input type="number" name="flip_aug_probability" value="0.5" step="0.1" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.aug.flip_aug_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="random_crop_scale" data-lang-key="ui.training.aug.crop_scale"></label>
                                    <input type="number" name="random_crop_scale" value="1.0" step="0.05" min="0.5" max="1.0">
                                    <div class="help-text" data-lang-key="ui.training.aug.crop_scale_help"></div>
                                </div>
                            </div>
                            
                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.aug.caption_aug_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="caption_dropout_rate" data-lang-key="ui.training.aug.dropout"></label>
                                    <input type="number" name="caption_dropout_rate" value="0.0" step="0.1">
                                    <div class="help-text" data-lang-key="ui.training.aug.dropout_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="caption_dropout_every_n_epochs" data-lang-key="ui.training.aug.dropout_epochs"></label>
                                    <input type="number" name="caption_dropout_every_n_epochs" value="0">
                                    <div class="help-text" data-lang-key="ui.training.aug.dropout_epochs_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="keep_tokens" data-lang-key="ui.training.aug.keep_tokens"></label>
                                    <input type="number" name="keep_tokens" value="0">
                                    <div class="help-text" data-lang-key="ui.training.aug.keep_tokens_help"></div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label" data-pointer="shuffle_caption_checkbox" style="margin-top: 30px;">
                                        <input type="checkbox" name="shuffle_caption" id="shuffle_caption_checkbox">
                                        <span data-lang-key="ui.training.aug.shuffle"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.aug.shuffle_help"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Config -->
                        <div id="cfg-basic" class="sub-tab-content active">
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="learning_rate" data-lang-key="ui.training.learning.lr"></label>
                                    <input type="text" name="learning_rate" value="1e-4">
                                    <div class="help-text" data-lang-key="ui.training.learning.lr_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="unet_lr" data-lang-key="ui.training.learning.unet_lr"></label>
                                    <input type="text" name="unet_lr" data-lang-placeholder="ui.training.learning.unet_lr_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.learning.unet_lr_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="text_encoder_lr" data-lang-key="ui.training.learning.te_lr"></label>
                                    <input type="text" name="text_encoder_lr" data-lang-placeholder="ui.training.learning.te_lr_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.learning.te_lr_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="lr_scheduler" data-lang-key="ui.training.learning.scheduler"></label>
                                    <select name="lr_scheduler">
                                        <option value="constant">constant</option>
                                        <option value="constant_with_warmup">constant_with_warmup</option>
                                        <option value="cosine" selected>cosine</option>
                                        <option value="cosine_with_restarts">cosine_with_restarts</option>
                                        <option value="linear">linear</option>
                                        <option value="polynomial">polynomial</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.learning.scheduler_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="warmup_steps" data-lang-key="ui.training.learning.warmup"></label>
                                    <input type="number" name="lr_warmup_steps" value="0">
                                    <div class="help-text" data-lang-key="ui.training.learning.warmup_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="lr_scheduler_num_cycles" data-lang-key="ui.training.learning.cycles"></label>
                                    <input type="number" name="lr_scheduler_num_cycles" value="1">
                                    <div class="help-text" data-lang-key="ui.training.learning.cycles_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="lr_scheduler_power" data-lang-key="ui.training.learning.scheduler_power"></label>
                                    <input type="number" name="lr_scheduler_power" value="1.0" step="0.1">
                                    <div class="help-text" data-lang-key="ui.training.learning.scheduler_power_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="lr_warmup_ratio" data-lang-key="ui.training.learning.warmup_ratio"></label>
                                <input type="number" name="lr_warmup_ratio" value="0.0" step="0.01">
                                <div class="help-text" data-lang-key="ui.training.learning.warmup_ratio_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="optimizer" data-lang-key="ui.training.learning.optimizer"></label>
                                <select name="optimizer_type">
                                    <option value="AdamW8bit">AdamW8bit (Memory-efficient)</option>
                                    <option value="AdamW">AdamW (Stable)</option>
                                    <option value="Lion">Lion (Experimental)</option>
                                    <option value="Lion8bit">Lion8bit (Experimental, Low Memory)</option>
                                    <option value="DAdaptAdam">DAdaptAdam (Adaptive LR)</option>
                                    <option value="Prodigy">Prodigy (Advanced)</option>
                                    <option value="CAME">CAME (Experimental)</option>
                                    <option value="Adafactor">Adafactor (Low mem, T5-style)</option>
                                    <option value="SGD">SGD (Simple)</option>
                                </select>
                                <div class="help-text" data-lang-key="ui.training.learning.optimizer_help"></div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label" data-pointer="ema_unet_checkbox">
                                    <input type="checkbox" name="ema_unet" id="ema_unet_checkbox">
                                    <span data-lang-key="ui.training.learning.ema_unet"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.learning.ema_unet_help"></div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label" data-pointer="ema_text_encoder_checkbox">
                                    <input type="checkbox" name="ema_text_encoder" id="ema_text_encoder_checkbox">
                                    <span data-lang-key="ui.training.learning.ema_te"></span>
                                </label>
                                <div class="help-text" data-lang-key="ui.training.learning.ema_te_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="ema_decay" data-lang-key="ui.training.learning.ema_decay"></label>
                                <input type="number" name="ema_decay" value="0.995" step="0.0005" min="0.9" max="0.9999">
                                <div class="help-text" data-lang-key="ui.training.learning.ema_decay_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="optimizer_args" data-lang-key="ui.training.learning.optimizer_args"></label>
                                <input type="text" name="optimizer_args" data-lang-placeholder="ui.training.learning.optimizer_args_placeholder">
                                <div class="help-text" data-lang-key="ui.training.learning.optimizer_args_help"></div>
                            </div>
                        </div>

                        <!-- Advanced Config -->
                        <div id="cfg-advanced" class="sub-tab-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="mixed_precision" data-lang-key="ui.training.advanced.mixed_precision"></label>
                                    <select name="mixed_precision">
                                        <option value="fp16">fp16</option>
                                        <option value="bf16">bf16</option>
                                        <option value="fp8">fp8</option>
                                        <option value="no">no</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.advanced.mixed_precision_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="grad_acc" data-lang-key="ui.training.advanced.grad_acc"></label>
                                    <input type="number" name="gradient_accumulation_steps" value="1">
                                    <div class="help-text" data-lang-key="ui.training.advanced.grad_acc_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="attention_backend" data-lang-key="ui.training.advanced.attention"></label>
                                    <select id="attention_backend" name="attention_backend">
                                        <option value="sdpa">SDPA (PyTorch 2.0+ Default)</option>
                                        <option value="xformers">xFormers (Fastest, requires install)</option>
                                        <option value="none">None (Slowest, most compatible)</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.advanced.attention_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="allow_tf32" data-lang-key="ui.training.advanced.tf32"></label>
                                    <select name="allow_tf32">
                                        <option value="true" selected>Enabled</option>
                                        <option value="false">Disabled</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.advanced.tf32_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="enable_aggressive_memory_saving" data-lang-key="ui.training.advanced.memory_saving"></label>
                                    <select id="enable_aggressive_memory_saving" name="enable_aggressive_memory_saving">
                                        <option value="false">Disabled (Faster training)</option>
                                        <option value="true">Enabled (Extra VRAM savings)</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.advanced.memory_saving_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="vae_batch_size" data-lang-key="ui.training.advanced.vae_batch"></label>
                                    <input type="number" name="vae_batch_size" data-lang-placeholder="ui.training.advanced.vae_batch_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.advanced.vae_batch_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="seed" data-lang-key="ui.training.advanced.seed"></label>
                                    <input type="number" name="seed" data-lang-placeholder="ui.training.advanced.seed_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.advanced.seed_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-pointer="max_token_length" data-lang-key="ui.training.advanced.max_token_length"></label>
                                <select name="max_token_length">
                                    <option value="75">75</option>
                                    <option value="150">150</option>
                                    <option value="225">225</option>
                                </select>
                                <div class="help-text" data-lang-key="ui.training.advanced.max_token_length_help"></div>
                            </div>
                            
                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.flux.title"></div>
                            <div class="form-group">
                                <label data-pointer="max_sequence_length" data-lang-key="ui.training.flux.max_seq_len"></label>
                                <input type="number" name="max_sequence_length" value="256" min="64" step="1">
                                <div class="help-text" data-lang-key="ui.training.flux.max_seq_len_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="weighting_scheme" data-lang-key="ui.training.flux.weighting_scheme"></label>
                                    <select name="weighting_scheme">
                                        <option value="none">None (Uniform)</option>
                                        <option value="logit_normal">Logit Normal</option>
                                        <option value="mode">Mode</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.flux.weighting_scheme_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="guidance_scale" data-lang-key="ui.training.flux.guidance_scale"></label>
                                    <input type="number" name="guidance_scale" value="3.5" step="0.1">
                                    <div class="help-text" data-lang-key="ui.training.flux.guidance_scale_help"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="logit_mean" data-lang-key="ui.training.flux.logit_mean"></label>
                                    <input type="number" name="logit_mean" value="0.0" step="0.1">
                                    <div class="help-text" data-lang-key="ui.training.flux.logit_mean_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="logit_std" data-lang-key="ui.training.flux.logit_std"></label>
                                    <input type="number" name="logit_std" value="1.0" step="0.1">
                                    <div class="help-text" data-lang-key="ui.training.flux.logit_std_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="mode_scale" data-lang-key="ui.training.flux.mode_scale"></label>
                                    <input type="number" name="mode_scale" value="1.29" step="0.01">
                                    <div class="help-text" data-lang-key="ui.training.flux.mode_scale_help"></div>
                                </div>
                            </div>

                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.timestep.title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="min_timestep" data-lang-key="ui.training.timestep.min"></label>
                                    <input type="number" name="min_timestep" data-lang-placeholder="ui.training.timestep.min_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.timestep.min_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="max_timestep" data-lang-key="ui.training.timestep.max"></label>
                                    <input type="number" name="max_timestep" data-lang-placeholder="ui.training.timestep.max_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.timestep.max_help"></div>
                                </div>
                            </div>

                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.caption.title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="caption_extension" data-lang-key="ui.training.caption.extension"></label>
                                    <input type="text" name="caption_extension" value=".txt">
                                    <div class="help-text" data-lang-key="ui.training.caption.extension_help"></div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label" style="margin-top: 30px;">
                                        <input type="checkbox" name="weighted_captions" id="weighted_captions_checkbox">
                                        <span data-lang-key="ui.training.caption.weighted"></span>
                                    </label>
                                    <div class="help-text" data-lang-key="ui.training.caption.weighted_help"></div>
                                </div>
                            </div>

                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.loss.title"></div>
                            
                            <!-- Quick Presets -->
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label data-pointer="loss_presets" data-lang-key="ui.training.loss.presets"></label>
                                <div class="preset-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button type="button" class="btn btn-sm" onclick="applyLossPreset('default')" data-lang-key="ui.training.loss.preset_default"></button>
                                    <button type="button" class="btn btn-sm" onclick="applyLossPreset('balanced')" data-lang-key="ui.training.loss.preset_balanced"></button>
                                    <button type="button" class="btn btn-sm" onclick="applyLossPreset('quality')" data-lang-key="ui.training.loss.preset_quality"></button>
                                    <button type="button" class="btn btn-sm" onclick="applyLossPreset('dark_light')" data-lang-key="ui.training.loss.preset_dark_light"></button>
                                </div>
                                <div class="help-text" data-lang-key="ui.training.loss.presets_help"></div>
                            </div>

                            <div id="dynamic-loss-fields"></div>
                            
                            <!-- Loss Type -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="loss_type" data-lang-key="ui.training.loss.type"></label>
                                    <select name="loss_type" onchange="updateLossTypeUI()">
                                        <option value="l2">L2 (MSE) - Standard</option>
                                        <option value="huber">Huber - Robust to outliers</option>
                                        <option value="smooth_l1">Smooth L1 - Very robust</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.loss.type_help"></div>
                                </div>
                                <div class="form-group" id="huber-c-group">
                                    <label data-pointer="huber_c" data-lang-key="ui.training.loss.huber_c"></label>
                                    <input type="number" name="huber_c" value="0.1" step="0.01" min="0.01">
                                    <div class="help-text" data-lang-key="ui.training.loss.huber_c_help"></div>
                                </div>
                            </div>

                            <!-- SNR Optimization -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="snr_gamma_input">
                                        <span data-lang-key="ui.training.loss.min_snr"></span>
                                        <label class="auto-toggle" style="margin-left: 8px; font-weight: normal;">
                                            <input type="checkbox" id="snr_gamma_auto" checked onchange="toggleAutoSNR()">
                                            <span class="auto-label" data-lang-key="ui.common.auto"></span>
                                        </label>
                                    </label>
                                    <input type="number" name="snr_gamma" id="snr_gamma_input" value="5" step="0.5" min="0" max="20" disabled>
                                    <div class="help-text" data-lang-key="ui.training.loss.min_snr_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="v_pred_like_loss">
                                        <span data-lang-key="ui.training.loss.v_pred"></span>
                                    </label>
                                    <input type="number" name="v_pred_like_loss" value="0" step="0.05" min="0" max="1">
                                    <div class="help-text" data-lang-key="ui.training.loss.v_pred_help"></div>
                                </div>
                            </div>

                            <!-- Noise Offset with Auto -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-pointer="noise_offset_input">
                                        <span data-lang-key="ui.training.loss.noise_offset"></span>
                                        <label class="auto-toggle" style="margin-left: 8px; font-weight: normal;">
                                            <input type="checkbox" id="noise_offset_auto" onchange="toggleAutoNoiseOffset()">
                                            <span class="auto-label" data-lang-key="ui.common.auto"></span>
                                        </label>
                                    </label>
                                    <input type="number" name="noise_offset_strength" id="noise_offset_input" value="0" step="0.01" min="0" max="0.2">
                                    <div class="help-text" data-lang-key="ui.training.loss.noise_offset_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-pointer="ip_noise_gamma" data-lang-key="ui.training.loss.ip_noise"></label>
                                    <input type="number" name="ip_noise_gamma" value="0" step="0.01" min="0" max="0.1">
                                    <div class="help-text" data-lang-key="ui.training.loss.ip_noise_help"></div>
                                </div>
                            </div>

                            <!-- Advanced toggles in a compact grid -->
                            <div class="form-group mt-2">
                                <label data-pointer="advanced_loss_options" data-lang-key="ui.training.loss.advanced_title"></label>
                                <div class="checkbox-grid">
                                    <label class="checkbox-label compact" data-pointer="zero_terminal_snr_checkbox">
                                        <input type="checkbox" name="zero_terminal_snr" id="zero_terminal_snr_checkbox">
                                        <span data-lang-key="ui.training.loss.zero_terminal_snr"></span>
                                        <span class="badge auto-badge" id="zsnr_auto_badge" style="display: none;" data-lang-key="ui.common.auto"></span>
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" name="debiased_estimation_loss" id="debiased_estimation_loss_checkbox">
                                        <span data-lang-key="ui.training.loss.debiased"></span>
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" name="scale_v_pred_loss_like_noise_pred" id="scale_v_pred_checkbox">
                                        <span data-lang-key="ui.training.loss.scale_v_pred"></span>
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" name="masked_loss" id="masked_loss_checkbox">
                                        <span data-lang-key="ui.training.loss.masked"></span>
                                    </label>
                                </div>
                                <div class="help-text" data-lang-key="ui.training.loss.advanced_help"></div>
                            </div>

                            <div class="field-title" style="margin-top: 16px;" data-lang-key="ui.training.loss.optimization_title"></div>
                            <div id="dynamic-optim-fields"></div>
                        </div>

                        <!-- Samples Config -->
                        <div id="cfg-samples" class="sub-tab-content">
                            <div class="field-title" data-lang-key="ui.training.samples.schedule_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.every_n_steps"></label>
                                    <input type="number" name="sample_every_n_steps" data-lang-placeholder="ui.training.samples.every_n_steps_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.samples.every_n_steps_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.every_n_epochs"></label>
                                    <input type="number" name="sample_every_n_epochs" data-lang-placeholder="ui.training.samples.every_n_epochs_placeholder">
                                    <div class="help-text" data-lang-key="ui.training.samples.every_n_epochs_help"></div>
                                </div>
                            </div>

                            <div class="field-title" style="margin-top: 20px;" data-lang-key="ui.training.samples.prompts_title"></div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.samples.prompts"></label>
                                <textarea name="sample_prompts" rows="5" data-lang-placeholder="ui.training.samples.prompts_placeholder"></textarea>
                                <div class="help-text" data-lang-key="ui.training.samples.prompts_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.samples.neg_prompt"></label>
                                <input type="text" name="sample_negative_prompt" data-lang-placeholder="ui.training.samples.neg_prompt_placeholder">
                                <div class="help-text" data-lang-key="ui.training.samples.neg_prompt_help"></div>
                            </div>

                            <div class="field-title" style="margin-top: 20px;" data-lang-key="ui.training.samples.inference_title"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.sampler"></label>
                                    <select name="sample_sampler">
                                        <option value="euler">Euler</option>
                                        <option value="euler_a" selected>Euler A (recommended)</option>
                                        <option value="ddim">DDIM</option>
                                        <option value="pndm">PNDM</option>
                                        <option value="lms">LMS</option>
                                        <option value="heun">Heun</option>
                                        <option value="dpm_2">DPM++ 2M</option>
                                        <option value="dpm_2_a">DPM++ 2M Karras</option>
                                        <option value="k_lms">K-LMS</option>
                                    </select>
                                    <div class="help-text" data-lang-key="ui.training.samples.sampler_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.inference_steps"></label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="range" name="sample_num_inference_steps" min="10" max="50" value="20" style="flex: 1;">
                                        <span id="sample_steps_value" style="min-width: 30px;">20</span>
                                    </div>
                                    <div class="help-text" data-lang-key="ui.training.samples.inference_steps_help"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.cfg_scale"></label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="range" name="sample_guidance_scale" min="0" max="20" step="0.5" value="7.5" style="flex: 1;">
                                        <span id="sample_guidance_value" style="min-width: 30px;">7.5</span>
                                    </div>
                                    <div class="help-text" data-lang-key="ui.training.samples.cfg_scale_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.seed"></label>
                                    <input type="number" name="sample_seed" value="-1">
                                    <div class="help-text" data-lang-key="ui.training.samples.seed_help"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.samples.num_images"></label>
                                    <input type="number" name="num_validation_images" value="4">
                                    <div class="help-text" data-lang-key="ui.training.samples.num_images_help"></div>
                                </div>
                            </div>

                            <div class="field-title" style="margin-top: 24px;" data-lang-key="ui.training.samples.generated_title"></div>
                            <div id="samples-gallery" class="samples-grid">
                                <div class="gallery-placeholder">
                                    <p data-lang-key="ui.training.samples.gallery_placeholder"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata Config -->
                        <div id="cfg-meta" class="sub-tab-content">
                            <div class="form-group">
                                <label data-lang-key="ui.training.metadata.comment"></label>
                                <input type="text" name="training_comment" data-lang-placeholder="ui.training.metadata.comment_placeholder">
                                <div class="help-text" data-lang-key="ui.training.metadata.comment_help"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label data-lang-key="ui.training.metadata.title"></label>
                                    <input type="text" name="metadata_title">
                                    <div class="help-text" data-lang-key="ui.training.metadata.title_help"></div>
                                </div>
                                <div class="form-group">
                                    <label data-lang-key="ui.training.metadata.author"></label>
                                    <input type="text" name="metadata_author">
                                    <div class="help-text" data-lang-key="ui.training.metadata.author_help"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.metadata.desc"></label>
                                <textarea name="metadata_description" rows="3" data-lang-placeholder="ui.training.metadata.desc_placeholder"></textarea>
                                <div class="help-text" data-lang-key="ui.training.metadata.desc_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.metadata.license"></label>
                                <input type="text" name="metadata_license" data-lang-placeholder="ui.training.metadata.license_placeholder">
                                <div class="help-text" data-lang-key="ui.training.metadata.license_help"></div>
                            </div>
                            <div class="form-group">
                                <label data-lang-key="ui.training.metadata.tags"></label>
                                <input type="text" name="metadata_tags" data-lang-placeholder="ui.training.metadata.tags_placeholder">
                                <div class="help-text" data-lang-key="ui.training.metadata.tags_help"></div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Progress Section -->
                <div class="card progress-section">
                    <div class="control-bar">
                        <button id="btn-toggle-train" class="btn-primary" data-lang-key="ui.training.progress.start"></button>
                        <div class="status-badge">
                            <span class="status-dot" id="training-dot"></span>
                            <span id="training-status" data-lang-key="ui.training.progress.idle"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATASET TAB REMOVED -->

            <!-- CONSOLE TAB -->
            <div id="tab-console" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title" data-lang-key="ui.console.title"></h1>
                    <p class="page-subtitle" data-lang-key="ui.console.subtitle"></p>
                </div>

                <div class="card">
                    <!-- Stats Bar -->
                    <div class="console-stats">
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.status"></span>
                            <span class="stat-value" id="console-status" data-lang-key="ui.training.progress.idle"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.step"></span>
                            <span class="stat-value" id="console-step">0 / 0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.loss"></span>
                            <span class="stat-value accent" id="console-loss">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.eta"></span>
                            <span class="stat-value" id="console-eta">--:--:--</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress-container mb-2">
                        <div class="progress-bar-bg">
                            <div id="console-progress-fill" class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                       
                        <div class="progress-info">
                            <span id="console-progress-text">0%</span>
                            <span id="console-epoch-text" data-lang-key="ui.training.progress.epoch_prefix"></span>
                        </div>
                    </div>

                    <!-- System Stats Bar -->
                    <div class="console-stats system-stats">
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.vram"></span>
                            <span class="stat-value" id="console-vram">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.gpu_load"></span>
                            <span class="stat-value" id="console-gpu-load">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.cpu_load"></span>
                            <span class="stat-value" id="console-cpu-load">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-lang-key="ui.console.ram"></span>
                            <span class="stat-value" id="console-ram">--</span>
                        </div>
                    </div>

                    <!-- Loss Chart -->
                    <div class="progress-grid mb-2">
                        <div class="chart-panel">
                            <canvas id="loss-chart"></canvas>
                            <div class="chart-overlay">
                                <div class="label" data-lang-key="ui.training.progress.loss_label"></div>
                                <div class="value" id="current-loss">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Full Console -->
                    <div class="console-container">
                        <div class="console-header">
                            <span data-lang-key="ui.console.output_title"></span>
                            <button class="console-btn" onclick="clearConsole()" data-lang-key="ui.console.clear"></button>
                        </div>
                        <div class="console-output" id="console-log">
                            <span class="console-line muted" data-lang-key="ui.console.waiting"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- METADATA TAB -->
            <div id="tab-metadata" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title" data-lang-key="ui.metadata_editor.title"></h1>
                    <p class="page-subtitle" data-lang-key="ui.metadata_editor.subtitle"></p>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label data-lang-key="ui.metadata_editor.select_file"></label>
                        <select id="meta-file-select">
                            <option value="" data-lang-key="ui.metadata_editor.select_placeholder"></option>
                        </select>
                        <div class="help-text" data-lang-key="ui.metadata_editor.select_help"></div>
                    </div>
                    <button class="btn-secondary" onclick="loadMetadata()" data-lang-key="ui.metadata_editor.btn_load"></button>
                    <div class="help-text" style="margin-top: 8px;" data-lang-key="ui.metadata_editor.load_help"></div>
                    
                    <div id="meta-editor-area" class="hidden mt-2">
                        <div id="meta-fields"></div>
                        <button class="btn-primary mt-2" onclick="saveMetadata()" data-lang-key="ui.metadata_editor.btn_save"></button>
                    </div>
                </div>
            </div>

            <!-- CONVERSION TAB REMOVED -->
            <!-- <div id="tab-conversion" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title" data-lang-key="ui.training.conversion.title"></h1>
                    <p class="page-subtitle" data-lang-key="ui.training.conversion.subtitle"></p>
                </div>

                <div class="card">
                    <div class="card-title" data-lang-key="ui.training.conversion.card_title"></div>
                    <div class="help-text mb-2" data-lang-key="ui.training.conversion.help_text"></div>

                    <div class="form-group">
                        <label data-lang-key="ui.training.conversion.input_model"></label>
                        <div style="display: flex; gap: 8px;">
                            <select id="conv_input_file" style="flex: 1;">
                                <option value="" data-lang-key="ui.common.select_placeholder"></option>
                            </select>
                            <button class="btn-secondary" onclick="refreshConversionFiles()" data-lang-key="ui.training.conversion.btn_refresh"></button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label data-lang-key="ui.training.conversion.model_architecture"></label>
                        <select id="conv_model_type">
                            <option value="sdxl" data-lang-key="ui.training.model.type_sdxl"></option>
                            <option value="sd1.5" data-lang-key="ui.training.model.type_sd_legacy"></option>
                            <option value="sd3" data-lang-key="ui.training.model.type_sd3"></option>
                        </select>
                        <div class="help-text" data-lang-key="ui.training.conversion.architecture_help"></div>
                    </div>

                    <div class="form-group">
                        <label data-lang-key="ui.training.conversion.target_format"></label>
                        <select id="conv_target_format">
                            <option value="kohya" data-lang-key="ui.training.conversion.target_format_kohya"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label data-lang-key="ui.training.conversion.output_filename"></label>
                        <input type="text" id="conv_output_name" data-lang-placeholder="ui.training.conversion.output_filename_placeholder">
                    </div>

                    <button class="btn-primary" onclick="startConversion()" data-lang-key="ui.training.conversion.btn_convert"></button>
                    
                    <div id="conv-result" class="mt-2 hidden">
                        <div class="status-badge status-success" data-lang-key="ui.training.conversion.success"></div>
                        <p class="mt-1 mono" id="conv-result-path" style="font-size: 12px;"></p>
                    </div>
                </div>
            </div> -->

        </main>
    </div>

    <!-- New Preset Modal -->
    <div id="preset-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-lang-key="ui.modals.preset_title"></h2>
                <button class="modal-close" onclick="closePresetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-lang-key="ui.modals.preset_name"></label>
                    <input type="text" id="preset-name-input" data-lang-placeholder="ui.modals.preset_placeholder">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePresetModal()" data-lang-key="ui.modals.btn_cancel"></button>
                <button class="btn-primary" onclick="saveNewPreset()" data-lang-key="ui.modals.btn_create"></button>
            </div>
        </div>
    </div>

    <!-- Delete Preset Confirmation Modal -->
    <div id="delete-preset-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-lang-key="ui.modals.delete_title"></h2>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p><span data-lang-key="ui.modals.delete_confirm"></span> <strong id="delete-preset-name"></strong>?</p>
                <p style="color: var(--text-muted); font-size: 12px; margin-top: 12px;" data-lang-key="ui.modals.delete_warning"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteModal()" data-lang-key="ui.modals.btn_cancel"></button>
                <button class="btn-danger" onclick="confirmDeletePreset()" data-lang-key="ui.modals.btn_delete"></button>
            </div>
        </div>
    </div>

    <!-- Stop Training Confirmation Modal -->
    <div id="stop-training-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-lang-key="ui.modals.stop_title"></h2>
                <button class="modal-close" onclick="closeStopModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p data-lang-key="ui.modals.stop_confirm"></p>
                <p style="color: var(--text-muted); font-size: 12px; margin-top: 12px;" data-lang-key="ui.modals.stop_warning"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeStopModal()" data-lang-key="ui.modals.btn_cancel"></button>
                <button class="btn-danger" onclick="confirmStopTraining()" data-lang-key="ui.modals.btn_stop"></button>
            </div>
        </div>
    </div>

    <script src="/ui/app.js"></script>
</body>
</html>
